#!/usr/bin/env ruby
# Copyright (C) 2015 Electronic Arts Inc.  All rights reserved.

require 'awsudo'
require 'logger'
require 'socket'
require 'tmpdir'

def usage
  warn <<EOS
Usage:

  #{File.basename $0}
EOS
  exit 1
end

LOG_FILENAME    = File.join(ENV['HOME'], ".aws-agent.log")
CONFIG_FILENAME = File.join(ENV['HOME'], '.awsudo')

logger = Logger.new(LOG_FILENAME, "weekly")
logger.progname = "aws-agent"
logger.level = Logger::WARN

config = Hash[*File.read(CONFIG_FILENAME).
  scan(/^(\w+)\s*=\s*(.*)$/).flatten]
AWSUDO.idp_login_url = config['IDP_LOGIN_URL']
AWSUDO.saml_provider_name = config['SAML_PROVIDER_NAME']

username, password = AWSUDO.ask_for_credentials

socket_dir  = Dir.mktmpdir("aws-")
socket_name = File.join(socket_dir, "agent")

case ENV['SHELL'].split('/').last
when 'csh', 'tcsh'
  puts "setenv AWS_AUTH_SOCK #{socket_name}"
when 'fish'
  puts "set -gx AWS_AUTH_SOCK #{socket_name}"
else
  puts "AWS_AUTH_SOCK=#{socket_name}; export AWS_AUTH_SOCK;"
end

Process.daemon
$0 = 'aws-agent'
Process.setrlimit(Process::RLIMIT_CORE, 0, 0)
UNIXServer.open(socket_name) do |socket|
  loop do
    Thread.new(socket.accept) do |client|
      logger.debug "thread started"
      logger.debug "connection accepted: #{socket.inspect}"
      begin
        role_arn = client.gets.strip
        logger.debug "role ARN received: #{role_arn}"
        credentials = AWSUDO.assume_role_with_password(role_arn, username, password)
        client.puts credentials.to_json
      rescue => e
        logger.error e
        error = {:error => e}.to_json
        client.print error
      ensure
        logger.debug "Closing connection"
        client.close
        logger.debug "Connection closed"
      end
      logger.debug "Thread ending"
    end
  end
end

FileUtils.rmdir socket_dir
